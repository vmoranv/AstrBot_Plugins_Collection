name: ğŸ”„ åŒæ­¥å·²å…³é—­çš„Issues

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  sync-closed-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
      - name: Test authentication
        run: |
          echo "Testing GitHub API access..."
          response=$(curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/user")
          
          if echo "$response" | jq -e '.login' > /dev/null 2>&1; then
            user=$(echo "$response" | jq -r '.login')
            echo "âœ… Authentication successful for user: $user"
          else
            echo "âŒ Authentication failed"
            echo "$response"
            exit 1
          fi
          
      - name: Fetch original plugin data
        run: |
          echo "å¼€å§‹è·å–åŸå§‹æ’ä»¶æ•°æ®..."
          github_url="https://raw.githubusercontent.com/vmoranv/AstrBot_Plugins_Collection/main/plugins.json"
          
          # ä½¿ç”¨curlè·å–æ•°æ®
          http_code=$(curl -L -s --max-time 30 \
            -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            -H "User-Agent: GitHub-Action-Plugin-Transformer" \
            -H "Accept: application/json" \
            -w "%{http_code}" \
            -o "original_plugins.json" \
            "$github_url")
          
          echo "HTTPçŠ¶æ€ç : $http_code"
          
          # æ£€æŸ¥HTTPçŠ¶æ€ç 
          if [ "$http_code" -ne 200 ]; then
            echo "âŒ è·å–åŸå§‹æ•°æ®å¤±è´¥"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„JSON
          if ! jq empty original_plugins.json > /dev/null 2>&1; then
            echo "âŒ å“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼"
            exit 1
          fi
          
          echo "âœ… æˆåŠŸè·å–åŸå§‹æ’ä»¶æ•°æ®"
          
      - name: Get closed issues
        id: get_issues
        run: |
          echo "è·å–å·²å…³é—­çš„Issues..."
          
          # è·å–å·²å…³é—­çš„Issuesåˆ—è¡¨ (çŠ¶æ€ä¸ºclosedä¸”æœ‰plugin-publishæ ‡ç­¾)
          closed_issues=$(curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues?state=closed&labels=plugin-publish&per_page=100" | \
            jq -r 'map({key: .title, value: .number}) | from_entries')
          
          echo "closed_issues=$closed_issues" >> $GITHUB_ENV
          
      - name: Process plugins and clean up deleted issues
        run: |
          echo "å¤„ç†æ’ä»¶æ•°æ®å¹¶æ¸…ç†å·²åˆ é™¤çš„issue..."
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
          touch temp_plugins.json
          
          # è¯»å–åŸå§‹æ’ä»¶æ•°æ®
          if [ ! -f original_plugins.json ]; then
            echo "âŒ æœªæ‰¾åˆ°åŸå§‹æ’ä»¶æ•°æ®æ–‡ä»¶"
            exit 1
          fi
          
          # å¤åˆ¶åŸå§‹æ•°æ®åˆ°ä¸´æ—¶æ–‡ä»¶
          cp original_plugins.json temp_plugins.json
          
          # è·å–å½“å‰æ’ä»¶åç§°åˆ—è¡¨
          plugin_names=$(jq -r 'keys[]' temp_plugins.json)
          
          # éå†å·²å…³é—­çš„Issues
          echo "$closed_issues" | jq -r 'to_entries[] | "\(.key):\(.value)"' | while IFS=':' read -r issue_title issue_number; do
            # æå–æ’ä»¶åç§° (ä»issueæ ‡é¢˜ä¸­)
            # å‡è®¾æ ‡é¢˜æ ¼å¼ä¸º "[Plugin] æ’ä»¶å"
            plugin_name_from_issue=$(echo "$issue_title" | sed -E 's/\[Plugin\] //')
            
            # æ£€æŸ¥è¯¥æ’ä»¶æ˜¯å¦è¿˜åœ¨åŸå§‹æ•°æ®ä¸­
            if ! echo "$plugin_names" | grep -q "^$plugin_name_from_issue$"; then
              echo "æ’ä»¶ $plugin_name_from_issue å·²ä»åŸå§‹æ•°æ®ä¸­åˆ é™¤ï¼Œå…³é—­çš„Issue #$issue_number å°†è¢«æ¸…ç†"
              
              # åˆ é™¤å·²å…³é—­ä¸”å¯¹åº”æ’ä»¶å·²åˆ é™¤çš„Issue
              curl -s -X PATCH \
                -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                -d '{"state": "closed"}' \
                "https://api.github.com/repos/${{ github.repository }}/issues/$issue_number"
            else
              echo "æ’ä»¶ $plugin_name_from_issue ä»åœ¨åŸå§‹æ•°æ®ä¸­ï¼Œä¿ç•™Issue #$issue_number"
            fi
          done
          
          echo "âœ… æ¸…ç†å®Œæˆ"
          
      - name: Commit and push changes (if any)
        run: |
          # å…ˆæ‹‰å–è¿œç¨‹æ›´æ”¹ï¼Œä½¿ç”¨rebaseé¿å…åˆå¹¶æäº¤
          git pull --rebase https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
          
          git add .
          git diff --cached --quiet || git commit -m "ğŸ§¹ æ¸…ç†å·²åˆ é™¤æ’ä»¶å¯¹åº”çš„å·²å…³é—­Issues"
          
          # æ¨é€æ›´æ”¹
          git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main