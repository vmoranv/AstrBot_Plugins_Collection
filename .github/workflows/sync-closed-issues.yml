name: ğŸ”„ åŒæ­¥å·²å…³é—­çš„Issues

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  sync-closed-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
      - name: Test authentication
        run: |
          echo "Testing GitHub API access..."
          response=$(curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/user")
          
          if echo "$response" | jq -e '.login' > /dev/null 2>&1; then
            user=$(echo "$response" | jq -r '.login')
            echo "âœ… Authentication successful for user: $user"
          else
            echo "âŒ Authentication failed"
            echo "$response"
            exit 1
          fi
          
      - name: Fetch original plugin data
        run: |
          echo "å¼€å§‹è·å–åŸå§‹æ’ä»¶æ•°æ®..."
          github_url="https://raw.githubusercontent.com/vmoranv/AstrBot_Plugins_Collection/main/plugins.json"
          
          # ä½¿ç”¨curlè·å–æ•°æ®
          http_code=$(curl -L -s --max-time 30 \
            -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            -H "User-Agent: GitHub-Action-Plugin-Transformer" \
            -H "Accept: application/json" \
            -w "%{http_code}" \
            -o "original_plugins.json" \
            "$github_url")
          
          echo "HTTPçŠ¶æ€ç : $http_code"
          
          # æ£€æŸ¥HTTPçŠ¶æ€ç 
          if [ "$http_code" -ne 200 ]; then
            echo "âŒ è·å–åŸå§‹æ•°æ®å¤±è´¥"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„JSON
          if ! jq empty original_plugins.json > /dev/null 2>&1; then
            echo "âŒ å“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼"
            exit 1
          fi
          
          echo "âœ… æˆåŠŸè·å–åŸå§‹æ’ä»¶æ•°æ®"
          
      - name: Get closed issues
        id: get_issues
        run: |
          echo "è·å–å·²å…³é—­çš„Issues..."
          
          # å…ˆå°è¯•è·å–æ‰€æœ‰å·²å…³é—­çš„Issuesï¼Œä¸é™åˆ¶æ ‡ç­¾
          echo "è°ƒè¯•ï¼šè·å–æ‰€æœ‰å·²å…³é—­çš„Issues..."
          all_closed_issues=$(curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues?state=closed&per_page=100")
          
          echo "æ‰€æœ‰å·²å…³é—­Issuesæ•°é‡: $(echo "$all_closed_issues" | jq 'length')"
          echo "æ‰€æœ‰å·²å…³é—­Issuesæ ‡é¢˜:"
          echo "$all_closed_issues" | jq -r '.[].title'
          
          # è·å–å·²å…³é—­çš„Issuesåˆ—è¡¨ (çŠ¶æ€ä¸ºclosedä¸”æœ‰plugin-publishæ ‡ç­¾)
          echo "è°ƒè¯•ï¼šå°è¯•è·å–å¸¦plugin-publishæ ‡ç­¾çš„Issues..."
          closed_issues=$(curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues?state=closed&labels=plugin-publish&per_page=100" | \
            jq -r 'map({key: .title, value: .number}) | from_entries')
          
          echo "å¸¦plugin-publishæ ‡ç­¾çš„Issues: $closed_issues"
          echo "closed_issues=$closed_issues" >> $GITHUB_ENV
          
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¸¦plugin-publishæ ‡ç­¾çš„Issuesï¼Œåˆ™ä½¿ç”¨æ‰€æœ‰å·²å…³é—­çš„Issues
          if [ "$closed_issues" = "{}" ]; then
            echo "æœªæ‰¾åˆ°å¸¦plugin-publishæ ‡ç­¾çš„Issuesï¼Œä½¿ç”¨æ‰€æœ‰å·²å…³é—­çš„Issues..."
            closed_issues_details="$all_closed_issues"
          else
            # è·å–å·²å…³é—­Issuesçš„è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…å«æ’ä»¶ä¿¡æ¯ï¼‰
            closed_issues_details=$(curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues?state=closed&labels=plugin-publish&per_page=100")
          fi
          
          echo "æœ€ç»ˆä½¿ç”¨çš„Issuesæ•°é‡: $(echo "$closed_issues_details" | jq 'length')"
          echo "$closed_issues_details" > closed_issues_details.json
          
      - name: Process plugins and clean up deleted issues
        run: |
          echo "å¤„ç†æ’ä»¶æ•°æ®å¹¶æ¸…ç†å·²åˆ é™¤çš„issue..."
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
          touch temp_plugins.json
          
          # è¯»å–åŸå§‹æ’ä»¶æ•°æ®
          if [ ! -f original_plugins.json ]; then
            echo "âŒ æœªæ‰¾åˆ°åŸå§‹æ’ä»¶æ•°æ®æ–‡ä»¶"
            exit 1
          fi
          
          # å¤åˆ¶åŸå§‹æ•°æ®åˆ°ä¸´æ—¶æ–‡ä»¶
          cp original_plugins.json temp_plugins.json
          
          # è·å–å½“å‰æ’ä»¶åç§°åˆ—è¡¨
          plugin_names=$(jq -r 'keys[]' temp_plugins.json)
          
          # å¤„ç†å·²å…³é—­çš„Issuesï¼Œæå–æ’ä»¶ä¿¡æ¯å¹¶åŒæ­¥åˆ°plugins.json
          echo "ä»å·²å…³é—­çš„Issuesä¸­æå–æ’ä»¶ä¿¡æ¯..."
          
          # éå†å·²å…³é—­çš„Issuesè¯¦ç»†ä¿¡æ¯
          jq -c '.[]' closed_issues_details.json | while read -r issue; do
            issue_number=$(echo "$issue" | jq -r '.number')
            issue_title=$(echo "$issue" | jq -r '.title')
            issue_body=$(echo "$issue" | jq -r '.body')
            
            # æå–æ’ä»¶åç§° (ä»issueæ ‡é¢˜ä¸­)
            # å‡è®¾æ ‡é¢˜æ ¼å¼ä¸º "[Plugin] æ’ä»¶å"
            plugin_name_from_issue=$(echo "$issue_title" | sed -E 's/\[Plugin\] //')
            
            echo "å¤„ç†Issue #$issue_number: $plugin_name_from_issue"
            
            # å°è¯•ä»issue bodyä¸­æå–æ’ä»¶ä¿¡æ¯
            if [ "$issue_body" != "null" ] && [ "$issue_body" != "" ]; then
              # æŸ¥æ‰¾JSONæ ¼å¼çš„æ’ä»¶ä¿¡æ¯
              # é¦–å…ˆå°è¯•ä»ä»£ç å—ä¸­æå–JSON
              plugin_info=$(echo "$issue_body" | sed -n '/```json/,/```/p' | grep -v '```' | tr -d '\n' | tr -d '\r')
              
              # å¦‚æœä»£ç å—ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•ç›´æ¥æŸ¥æ‰¾JSON
              if [ -z "$plugin_info" ]; then
                plugin_info=$(echo "$issue_body" | grep -o '{[^{}]*"repo"[^{}]*}' | head -1)
              fi
              
              # å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•æ›´å®½æ³›çš„JSONåŒ¹é…
              if [ -z "$plugin_info" ]; then
                plugin_info=$(echo "$issue_body" | grep -o '{[^{}]*"display_name"[^{}]*}' | head -1)
              fi
              
              if [ -n "$plugin_info" ]; then
                echo "ä»Issue #$issue_number ä¸­æå–åˆ°æ’ä»¶ä¿¡æ¯"
                echo "æ’ä»¶ä¿¡æ¯é¢„è§ˆ: $(echo "$plugin_info" | head -c 200)..."
                
                # ä¿®å¤JSONæ ¼å¼ï¼šå¤„ç†è½¬ä¹‰å­—ç¬¦
                # ä½¿ç”¨printfæ¥æ­£ç¡®å¤„ç†è½¬ä¹‰å­—ç¬¦
                fixed_plugin_info=$(printf '%b\n' "$plugin_info" | sed 's/\\n/\\n/g' | sed 's/\\"/"/g' | sed 's/\\\\/\\/g')
                
                # éªŒè¯JSONæ ¼å¼å¹¶æ›´æ–°æ’ä»¶ä¿¡æ¯
                if echo "$fixed_plugin_info" | jq . > /dev/null 2>&1; then
                  # è·å–æ’ä»¶IDï¼ˆä»æ’ä»¶åç§°ç”Ÿæˆï¼‰
                  plugin_id=$(echo "$plugin_name_from_issue" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/_/g')
                  
                  # æ›´æ–°æ’ä»¶ä¿¡æ¯åˆ°temp_plugins.json
                  jq --arg id "$plugin_id" --argjson info "$fixed_plugin_info" '.[$id] = $info' temp_plugins.json > temp_plugins_updated.json && mv temp_plugins_updated.json temp_plugins.json
                  
                  echo "âœ… å·²æ›´æ–°æ’ä»¶ $plugin_name_from_issue çš„ä¿¡æ¯"
                else
                  echo "âŒ æ’ä»¶ä¿¡æ¯JSONæ ¼å¼æ— æ•ˆ"
                  echo "åŸå§‹æ’ä»¶ä¿¡æ¯: $plugin_info"
                  echo "ä¿®å¤åæ’ä»¶ä¿¡æ¯: $fixed_plugin_info"
                  
                  # å°è¯•ä½¿ç”¨jqç›´æ¥ä»bodyä¸­æå–JSON
                  echo "å°è¯•ä½¿ç”¨jqç›´æ¥æå–JSON..."
                  # å°†bodyå†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨jqæå–
                  echo "$issue_body" > temp_body.txt
                  extracted_json=$(jq -Rs 'capture("```json(?<json>.+?)```"; "s") | .json' temp_body.txt 2>/dev/null)
                  
                  if [ -n "$extracted_json" ] && echo "$extracted_json" | jq . > /dev/null 2>&1; then
                    plugin_id=$(echo "$plugin_name_from_issue" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/_/g')
                    jq --arg id "$plugin_id" --argjson info "$extracted_json" '.[$id] = $info' temp_plugins.json > temp_plugins_updated.json && mv temp_plugins_updated.json temp_plugins.json
                    echo "âœ… ä½¿ç”¨jqæˆåŠŸæå–å¹¶æ›´æ–°æ’ä»¶ $plugin_name_from_issue çš„ä¿¡æ¯"
                  else
                    echo "âŒ jqæå–ä¹Ÿå¤±è´¥äº†"
                  fi
                  rm -f temp_body.txt
                fi
              else
                echo "æœªåœ¨Issue #$issue_number ä¸­æ‰¾åˆ°æœ‰æ•ˆçš„æ’ä»¶ä¿¡æ¯"
                echo "Issue body é¢„è§ˆ: $(echo "$issue_body" | head -c 200)..."
              fi
            else
              echo "Issue #$issue_number æ²¡æœ‰å†…å®¹ï¼Œè·³è¿‡"
            fi
            
            # æ£€æŸ¥è¯¥æ’ä»¶æ˜¯å¦è¿˜åœ¨åŸå§‹æ•°æ®ä¸­
            if ! echo "$plugin_names" | grep -q "^$plugin_name_from_issue$"; then
              echo "æ’ä»¶ $plugin_name_from_issue ä¸åœ¨åŸå§‹æ•°æ®ä¸­ï¼Œä½†å·²ä»Issueä¸­æ·»åŠ "
            else
              echo "æ’ä»¶ $plugin_name_from_issue ä»åœ¨åŸå§‹æ•°æ®ä¸­ï¼Œä¿ç•™Issue #$issue_number"
            fi
          done
          
          # å¤„ç†ä¸åœ¨å·²å…³é—­Issuesä¸­çš„ç°æœ‰æ’ä»¶ï¼Œç¡®ä¿å®ƒä»¬è¢«ä¿ç•™
          echo "ç¡®ä¿ç°æœ‰æ’ä»¶æ•°æ®è¢«ä¿ç•™..."
          
          # è·å–æ‰€æœ‰å·²å…³é—­Issuesä¸­çš„æ’ä»¶åç§°
          closed_issue_plugins=$(jq -r '.[].title' closed_issues_details.json | sed -E 's/\[Plugin\] //' | sort | uniq)
          
          # éå†åŸå§‹æ’ä»¶æ•°æ®ä¸­çš„æ‰€æœ‰æ’ä»¶
          jq -r 'keys[]' original_plugins.json | while read -r plugin_id; do
            plugin_display_name=$(jq -r ".[\"$plugin_id\"].display_name" original_plugins.json)
            
            # æ£€æŸ¥æ’ä»¶æ˜¯å¦åœ¨å·²å…³é—­Issuesä¸­
            if ! echo "$closed_issue_plugins" | grep -q "^$plugin_display_name$"; then
              echo "ä¿ç•™ç°æœ‰æ’ä»¶: $plugin_display_name ($plugin_id)"
              # ç¡®ä¿è¯¥æ’ä»¶åœ¨temp_plugins.jsonä¸­å­˜åœ¨
              if ! jq -e ".[\"$plugin_id\"]" temp_plugins.json > /dev/null 2>&1; then
                # å¦‚æœä¸å­˜åœ¨ï¼Œä»åŸå§‹æ•°æ®ä¸­æ·»åŠ 
                jq --arg id "$plugin_id" --argjson info "$(jq ".[\"$plugin_id\"]" original_plugins.json)" '.[$id] = $info' temp_plugins.json > temp_plugins_updated.json && mv temp_plugins_updated.json temp_plugins.json
                echo "âœ… å·²æ¢å¤æ’ä»¶ $plugin_display_name çš„æ•°æ®"
              fi
            fi
          done
          
          # å°†æ›´æ–°åçš„æ’ä»¶æ•°æ®å¤åˆ¶åˆ°plugins.json
          cp temp_plugins.json plugins.json
          
          echo "âœ… å¤„ç†å®Œæˆ"
          echo "ğŸ“Š æœ€ç»ˆæ’ä»¶ç»Ÿè®¡:"
          jq -r 'keys | length as $count | "æ’ä»¶æ€»æ•°: \($count)"' plugins.json
          
      - name: Commit and push changes (if any)
        run: |
          # å…ˆæ‹‰å–è¿œç¨‹æ›´æ”¹ï¼Œä½¿ç”¨rebaseé¿å…åˆå¹¶æäº¤
          git pull --rebase https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
          
          git add .
          git diff --cached --quiet || git commit -m "ğŸ”„ åŒæ­¥å·²å…³é—­Issuesä¸­çš„æ’ä»¶ä¿¡æ¯åˆ°plugins.jsonå¹¶æ¸…ç†å·²åˆ é™¤æ’ä»¶å¯¹åº”çš„Issues"
          
          # æ¨é€æ›´æ”¹
          git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main